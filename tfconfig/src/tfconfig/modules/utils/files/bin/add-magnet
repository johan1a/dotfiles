#!/usr/bin/env fish
# Set this script as default application to use for magnet links in your browser
set -l magnet_link $argv
set -l sid_path ~/.local/bin/sid.qbittorrent

if not test -f $sid_path
    notify-send "Error: $sid_path does not exist"
    exit 1
end

set sid (cat $sid_path)

set -l response (http --ignore-stdin --headers --form POST http://192.168.1.221:30000/api/v2/torrents/add \
  Cookie:SID="$sid" \
  urls="$magnet_link" \
  savepath="/downloads" \
  paused:=false \
  2>&1) # Send stderr to stdout

if string match -q '*200 OK*' $response
  notify-send "Added magnet link
  $magnet_link"
else
  notify-send "Failed to add magnet link:
  $response"
end

